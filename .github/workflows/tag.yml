name: Tag and Release

on:
  push:
    tags:
      - 'v*.*.*'

# Prevent concurrent builds: only one at a time (main pushes + releases)
concurrency:
  group: main-build
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  draft-release:
    name: Create draft release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get tag version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" | tee -a "$GITHUB_OUTPUT"

      - name: Compare tag and Cargo versions
        env:
          TAG_VERSION: ${{ steps.version.outputs.version }}
        run: |
          CARGO_VERSION="$(yq -roy '.package.version' Cargo.toml)"
          if [[ "$TAG_VERSION" != "$CARGO_VERSION" ]]; then
            echo "❌ Error: Tag version ${TAG_VERSION} does not match Cargo.toml version ${CARGO_VERSION}" >&2
            exit 1
          fi

      - name: Check if release already exists
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view ${{ github.ref_name }} --repo ${{ github.repository }} >/dev/null 2>&1; then
            echo "❌ Error: Release ${{ steps.version.outputs.version }} already exists" >&2
            exit 1
          fi

      - name: Create Draft Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: true
          prerelease: false
          body: |
            Release ${{ github.ref_name }}

            ## Installation

            Download the appropriate binary for your platform from the assets below.

            ### From crates.io

            ```bash
            cargo install markdownlint-rs
            ```

            ### Binary Downloads

            See assets below for pre-built binaries for your platform.

            ### Verify checksums

            Each binary includes a `.sha256` file for verification:

            ```bash
            # Linux/macOS
            sha256sum -c mdlint-*.sha256

            # Windows (PowerShell)
            $expected = (Get-Content mdlint-*.sha256).Split()[0]
            $actual = (Get-FileHash mdlint.exe).Hash.ToLower()
            if ($expected -eq $actual) { "OK" } else { "FAILED" }
            ```

            ### Docker

            ```bash
            docker pull ghcr.io/${{ github.repository }}:${{ steps.get_version.outputs.version }}
            ```

  ci:
    name: Run CI Checks
    needs: draft-release
    uses: ./.github/workflows/ci.yml

  # Build and upload release binaries
  build-release:
    name: Build Release Binaries
    needs: draft-release
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: mdlint
            asset_name: mdlint-linux-x86_64
            archive_format: tar.gz

          # Linux x86_64 (musl - static binary)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact_name: mdlint
            asset_name: mdlint-linux-x86_64-musl
            archive_format: tar.gz

          # Linux aarch64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact_name: mdlint
            asset_name: mdlint-linux-aarch64
            archive_format: tar.gz
            cross: true

          # macOS x86_64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: mdlint
            asset_name: mdlint-macos-x86_64
            archive_format: tar.gz

          # macOS aarch64 (Apple Silicon)
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: mdlint
            asset_name: mdlint-macos-aarch64
            archive_format: tar.gz

          # Windows x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: mdlint.exe
            asset_name: mdlint-windows-x86_64.exe
            archive_format: zip

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install musl tools (Linux musl only)
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Build release binary (Unix)
        if: ${{ !matrix.cross && matrix.os != 'windows-latest' }}
        run: |
          cargo build --release --target ${{ matrix.target }}
          strip target/${{ matrix.target }}/release/${{ matrix.artifact_name }}

      - name: Build release binary (Windows)
        if: ${{ !matrix.cross && matrix.os == 'windows-latest' }}
        run: |
          cargo build --release --target ${{ matrix.target }}

      - name: Build release binary (cross)
        if: matrix.cross
        run: |
          cargo install cross --git https://github.com/cross-rs/cross
          cross build --release --target ${{ matrix.target }}

      - name: Package release (Unix)
        if: matrix.os != 'windows-latest'
        working-directory: target/${{ matrix.target }}/release
        run: |
          # Copy binary with asset name
          cp ${{ matrix.artifact_name }} ${{ matrix.asset_name }}

          # Generate checksums
          sha256sum ${{ matrix.asset_name }} > ${{ matrix.asset_name }}.sha256

          # Create tarball with checksum
          tar czf ${{ matrix.asset_name }}.tar.gz ${{ matrix.artifact_name }}
          sha256sum ${{ matrix.asset_name }}.tar.gz > ${{ matrix.asset_name }}.tar.gz.sha256

      - name: Package release (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        working-directory: target/${{ matrix.target }}/release
        run: |
          # Copy binary with asset name
          Copy-Item -Path ${{ matrix.artifact_name }} -Destination ${{ matrix.asset_name }}

          # Generate checksums
          $hash = (Get-FileHash ${{ matrix.asset_name }} -Algorithm SHA256).Hash.ToLower()
          "$hash  ${{ matrix.asset_name }}" | Out-File -Encoding ASCII ${{ matrix.asset_name }}.sha256

          # Create zip with checksum
          Compress-Archive -Path ${{ matrix.artifact_name }} -DestinationPath ${{ matrix.asset_name }}.zip
          $hash = (Get-FileHash ${{ matrix.asset_name }}.zip -Algorithm SHA256).Hash.ToLower()
          "$hash  ${{ matrix.asset_name }}.zip" | Out-File -Encoding ASCII ${{ matrix.asset_name }}.zip.sha256

      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        working-directory: target/${{ matrix.target }}/release
        shell: bash
        run: |
          gh release upload ${{ github.ref_name }} \
            ${{ matrix.asset_name }} \
            ${{ matrix.asset_name }}.sha256 \
            ${{ matrix.asset_name }}.${{ matrix.archive_format }} \
            ${{ matrix.asset_name }}.${{ matrix.archive_format }}.sha256 \
            --clobber \
            --repo ${{ github.repository }}

  build-docker:
    name: Build Docker Image (${{ matrix.platform }})
    needs: build-release
    runs-on: ${{ matrix.runs-on }}
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runs-on: ubuntu-latest
          - platform: linux/arm64
            runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64' }}
            type=raw,value=${{ matrix.platform == 'linux/amd64' && 'latest-amd64' || 'latest-arm64' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  publish-docker:
    name: Publish Multi-Platform Docker Manifest
    needs: build-docker
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" | tee -a "$GITHUB_OUTPUT"

      - name: Create and push multi-platform manifest
        run: |
          IMAGE_REPO="ghcr.io/${{ github.repository }}"
          VERSION="${{ steps.version.outputs.version }}"

          # Create manifest for version tags
          docker buildx imagetools create \
            --tag "${IMAGE_REPO}:${VERSION}" \
            --tag "${IMAGE_REPO}:latest" \
            "${IMAGE_REPO}:${VERSION}-amd64" \
            "${IMAGE_REPO}:${VERSION}-arm64"

          # Also update major.minor and major tags
          MAJOR_MINOR=$(echo "${VERSION}" | cut -d. -f1-2)
          MAJOR=$(echo "${VERSION}" | cut -d. -f1)

          docker buildx imagetools create \
            --tag "${IMAGE_REPO}:${MAJOR_MINOR}" \
            "${IMAGE_REPO}:${VERSION}-amd64" \
            "${IMAGE_REPO}:${VERSION}-arm64"

          docker buildx imagetools create \
            --tag "${IMAGE_REPO}:${MAJOR}" \
            "${IMAGE_REPO}:${VERSION}-amd64" \
            "${IMAGE_REPO}:${VERSION}-arm64"

  publish-crates-io:
    name: Publish to crates.io
    needs: build-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish --token ${CARGO_REGISTRY_TOKEN}

  publish-release:
    name: Publish Release
    needs:
      - publish-crates-io
      - publish-docker
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Publish Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release edit ${{ github.ref_name }} --repo ${{ github.repository }} --draft=false
